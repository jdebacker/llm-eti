name: Build JupyterBook

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true
        cache-dependency-glob: "pyproject.toml"
    
    - name: Install dependencies
      run: |
        uv venv --python 3.13
        uv sync --no-editable
    
    - name: Create placeholder test data
      run: |
        cd book
        mkdir -p data
        # Create minimal placeholder CSV files to allow book building
        echo "round,rate1,rate2,treatment,max_labor,chosen_labor,personality,raw_response" > data/pknf_results_gpt-4o-mini_test.csv
        echo "1,25,50,prog_flat25,600,400,Standard,Test response" >> data/pknf_results_gpt-4o-mini_test.csv
        
        echo "broad_income,taxable_income,mtr_last,mtr_this,taxable_income_this,implied_eti,raw_response" > data/gruber_saez_results_gpt-4o-mini_test.csv
        echo "50000,37500,0.25,0.30,35000,0.4,Test response" >> data/gruber_saez_results_gpt-4o-mini_test.csv
    
    - name: Generate figures and tables
      run: |
        cd book
        make figures
        make tables
    
    - name: Build JupyterBook
      run: |
        cd book
        uv run jupyter-book build .
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: jupyterbook-html
        path: book/_build/html/
    
    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: book/_build/html
        cname: llm-eti.maxghenis.com  # Optional: add your custom domain