name: Build JupyterBook

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true
        cache-dependency-glob: "pyproject.toml"
    
    - name: Install dependencies
      run: |
        uv venv --python 3.13
        uv sync --no-editable
    
    - name: Create placeholder test data
      run: |
        cd book
        mkdir -p data
        # Create more realistic placeholder CSV files with multiple rows
        cat > data/pknf_results_gpt-4o-mini_test.csv << 'EOF'
        round,rate1,rate2,treatment,max_labor,chosen_labor,personality,raw_response
        1,25,50,prog_flat25,600,400,Standard,Test response
        2,25,50,prog_flat25,500,350,Standard,Test response
        3,25,50,prog_flat25,400,300,Standard,Test response
        4,25,50,prog_flat25,300,250,Standard,Test response
        EOF
        
        # Create data with varying income levels for plotting
        cat > data/gruber_saez_results_gpt-4o-mini_test.csv << 'EOF'
        broad_income,taxable_income,mtr_last,mtr_this,taxable_income_this,implied_eti,raw_response
        50000,37500,0.25,0.30,35000,0.4,Test response
        60000,45000,0.25,0.30,42000,0.4,Test response
        70000,52500,0.25,0.30,49000,0.4,Test response
        80000,60000,0.30,0.35,55000,0.5,Test response
        90000,67500,0.30,0.35,62000,0.5,Test response
        100000,75000,0.30,0.35,69000,0.5,Test response
        110000,82500,0.35,0.40,75000,0.6,Test response
        120000,90000,0.35,0.40,82000,0.6,Test response
        130000,97500,0.35,0.40,89000,0.6,Test response
        140000,105000,0.35,0.40,96000,0.6,Test response
        150000,112500,0.35,0.40,103000,0.6,Test response
        EOF
    
    - name: Generate figures and tables
      run: |
        cd book
        make figures
        make tables
    
    - name: Build JupyterBook
      run: |
        cd book
        uv run jupyter-book build .
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: jupyterbook-html
        path: book/_build/html/
    
    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: book/_build/html
        cname: llm-eti.maxghenis.com  # Optional: add your custom domain